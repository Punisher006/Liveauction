<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Security meta tags -->
    <meta http-equiv="Content-Security-Policy" 
          content="default-src 'self'; 
               script-src 'self' 'unsafe-inline'; 
               style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; 
               font-src 'self' https://fonts.gstatic.com; 
               img-src 'self' data: https:; 
               connect-src 'self'">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">
    <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Password - Live Auction</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/auth.css">
</head>
<body>
    <div class="auth-container">
        <div class="auth-card">
            <div class="auth-header">
                <div class="auth-logo">Live Auction</div>
                <h2>Set New Password</h2>
                <p class="auth-subtitle">Create a new password for your account</p>
            </div>

            <!-- Invalid Token Message -->
            <div id="invalid-token-message" class="message error hidden">
                <h3>Invalid Reset Link</h3>
                <p>This password reset link is invalid or has expired.</p>
                <p>Please request a <a href="forgot-password.html" class="forgot-password-link">new password reset</a>.</p>
            </div>

            <!-- Reset Form -->
            <div id="reset-form" class="step-container step-visible">
                <form id="reset-password-form" class="auth-form">
                    <input type="hidden" id="reset-token" name="token">
                    
                    <div class="form-group">
                        <label for="newPassword">New Password</label>
                        <input type="password" id="newPassword" name="newPassword" minlength="6" required 
                               placeholder="Enter new password (min. 6 characters)">
                    </div>
                    
                    <div class="form-group">
                        <label for="confirmPassword">Confirm New Password</label>
                        <input type="password" id="confirmPassword" name="confirmPassword" required 
                               placeholder="Confirm your new password">
                    </div>
                    
                    <button type="submit" class="auth-button btn-primary" id="submit-button">
                        <span class="btn-text">Reset Password</span>
                        <div class="loading hidden"></div>
                    </button>
                </form>

                <div id="message-container" class="message-container"></div>

                <div class="auth-footer">
                    <p><a href="login.html" class="forgot-password-link">Back to Login</a></p>
                </div>
            </div>

            <!-- Success Message -->
            <div id="success-message" class="success-container hidden">
                <div class="success-icon">âœ…</div>
                <h3>Password Reset Successful!</h3>
                <p>Your password has been reset successfully.</p>
                <p>Redirecting to login page...</p>
            </div>
        </div>
    </div>

    <script>
        // Get token from URL
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');

        document.addEventListener('DOMContentLoaded', async function() {
            if (!token) {
                showInvalidToken();
                return;
            }

            // Set token in hidden field
            document.getElementById('reset-token').value = token;

            // Validate token
            try {
                const response = await fetch(`http://localhost:5000/api/password-reset/validate-reset-token/${token}`);
                const data = await response.json();

                if (!data.valid) {
                    showInvalidToken(data.message);
                }
            } catch (error) {
                console.error('Token validation error:', error);
                showInvalidToken('Failed to validate reset token');
            }
        });

        function showInvalidToken(message = 'Invalid reset token') {
            document.getElementById('reset-form').classList.remove('step-visible');
            document.getElementById('reset-form').classList.add('step-hidden');
            document.getElementById('invalid-token-message').classList.remove('hidden');
            
            if (message) {
                const messageElement = document.getElementById('invalid-token-message');
                messageElement.querySelector('p').textContent = message;
            }
        }

        function showMessage(message, type, container = null) {
            const targetContainer = container || document.getElementById('message-container');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.textContent = message;
            
            targetContainer.innerHTML = '';
            targetContainer.appendChild(messageDiv);

            // Auto-remove success messages after 5 seconds
            if (type === 'success') {
                setTimeout(() => {
                    if (messageDiv.parentNode) {
                        messageDiv.remove();
                    }
                }, 5000);
            }
        }

        document.getElementById('reset-password-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);
            const submitButton = document.getElementById('submit-button');
            const btnText = submitButton.querySelector('.btn-text');
            const loading = submitButton.querySelector('.loading');

            // Clear previous messages
            const messageContainer = document.getElementById('message-container');
            messageContainer.innerHTML = '';

            // Validate passwords match
            if (data.newPassword !== data.confirmPassword) {
                showMessage('Passwords do not match', 'error', messageContainer);
                return;
            }

            if (data.newPassword.length < 6) {
                showMessage('Password must be at least 6 characters long', 'error', messageContainer);
                return;
            }

            // Show loading state
            btnText.textContent = 'Resetting Password...';
            loading.classList.remove('hidden');
            submitButton.disabled = true;

            try {
                const response = await fetch('http://localhost:5000/api/password-reset/reset-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (response.ok) {
                    // Show success message and redirect
                    document.getElementById('reset-form').classList.remove('step-visible');
                    document.getElementById('reset-form').classList.add('step-hidden');
                    document.getElementById('success-message').classList.remove('hidden');
                    
                    // Redirect to login after 3 seconds
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 3000);
                } else {
                    throw new Error(result.message || 'Failed to reset password');
                }
            } catch (error) {
                console.error('Reset password error:', error);
                showMessage(error.message, 'error', messageContainer);
            } finally {
                // Restore button
                btnText.textContent = 'Reset Password';
                loading.classList.add('hidden');
                submitButton.disabled = false;
            }
        });
    </script>
</body>
</html>