<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Password - Live Auction</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <header>
        <h1>Set New Password</h1>
        <p>Create a new password for your account</p>
    </header>

    <main>
        <section class="section auth-section">
            <h2>Reset Password</h2>
            
            <!-- Invalid Token Message -->
            <div id="invalid-token-message" class="message error hidden">
                <h3>Invalid Reset Link</h3>
                <p>This password reset link is invalid or has expired.</p>
                <p>Please request a <a href="forgot-password.html" class="forgot-password-link">new password reset</a>.</p>
            </div>

            <!-- Reset Form -->
            <div id="reset-form" class="step-container step-visible">
                <form id="reset-password-form">
                    <input type="hidden" id="reset-token" name="token">
                    
                    <div class="form-group">
                        <label for="newPassword">New Password:</label>
                        <input type="password" id="newPassword" name="newPassword" minlength="6" required 
                               placeholder="Enter new password (min. 6 characters)">
                    </div>
                    
                    <div class="form-group">
                        <label for="confirmPassword">Confirm New Password:</label>
                        <input type="password" id="confirmPassword" name="confirmPassword" required 
                               placeholder="Confirm your new password">
                    </div>
                    
                    <button type="submit" class="auth-button">Reset Password</button>
                </form>
                <div id="message" class="message"></div>
                <p class="text-center mt-15"><a href="login.html" class="forgot-password-link">Back to Login</a></p>
            </div>

            <!-- Success Message -->
            <div id="success-message" class="message success hidden">
                <h3>Password Reset Successful!</h3>
                <p>Your password has been reset successfully.</p>
                <p>You can now <a href="login.html" class="forgot-password-link">login with your new password</a>.</p>
            </div>
        </section>
    </main>

    <footer>
        <p>&copy; 2025 Live Auction. All rights reserved.</p>
    </footer>

    <script>
        // Get token from URL
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');

        document.addEventListener('DOMContentLoaded', async function() {
            if (!token) {
                showInvalidToken();
                return;
            }

            // Set token in hidden field
            document.getElementById('reset-token').value = token;

            // Validate token
            try {
                const response = await fetch(`http://localhost:5000/api/password-reset/validate-reset-token/${token}`);
                const data = await response.json();

                if (!data.valid) {
                    showInvalidToken();
                }
            } catch (error) {
                console.error('Token validation error:', error);
                showInvalidToken();
            }
        });

        function showInvalidToken() {
            document.getElementById('reset-form').classList.remove('step-visible');
            document.getElementById('reset-form').classList.add('step-hidden');
            document.getElementById('invalid-token-message').classList.remove('hidden');
        }

        document.getElementById('reset-password-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);
            const messageDiv = document.getElementById('message');
            const submitButton = e.target.querySelector('button[type="submit"]');
            const originalText = submitButton.textContent;

            // Clear previous messages
            messageDiv.innerHTML = '';
            messageDiv.className = 'message';

            // Validate passwords match
            if (data.newPassword !== data.confirmPassword) {
                messageDiv.textContent = 'Passwords do not match';
                messageDiv.className = 'message error';
                return;
            }

            // Show loading state
            submitButton.innerHTML = '<div class="loading"></div> Resetting...';
            submitButton.disabled = true;

            try {
                const response = await fetch('http://localhost:5000/api/password-reset/reset-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (response.ok) {
                    // Show success message
                    document.getElementById('reset-form').classList.remove('step-visible');
                    document.getElementById('reset-form').classList.add('step-hidden');
                    document.getElementById('success-message').classList.remove('hidden');
                } else {
                    messageDiv.textContent = result.message || 'Failed to reset password';
                    messageDiv.className = 'message error';
                }
            } catch (error) {
                console.error('Reset password error:', error);
                messageDiv.textContent = 'Failed to reset password. Please try again.';
                messageDiv.className = 'message error';
            } finally {
                // Restore button
                submitButton.textContent = originalText;
                submitButton.disabled = false;
            }
        });
    </script>
</body>
</html>