<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Security meta tags -->
    <meta http-equiv="Content-Security-Policy" 
          content="default-src 'self'; 
               script-src 'self' 'unsafe-inline'; 
               style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; 
               font-src 'self' https://fonts.gstatic.com; 
               img-src 'self' data: https:; 
               connect-src 'self'">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">
    <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Register - Live Auction</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/auth.css">
</head>
<body>
    <div class="auth-container">
        <div class="auth-card">
            <div class="auth-header">
                <div class="auth-logo">Live Auction</div>
                <p class="auth-subtitle">Create your investment account</p>
            </div>

            <form id="register-form" class="auth-form">
                <div class="form-group">
                    <label for="fullName">Full Name</label>
                    <input type="text" id="fullName" name="fullName" required 
                           placeholder="Enter your full legal name">
                </div>

                <div class="form-group">
                    <label for="email">Email Address</label>
                    <input type="email" id="email" name="email" required 
                           placeholder="Enter your email address">
                </div>

                <div class="form-group">
                    <label for="phone">Mpesa Phone Number</label>
                    <input type="tel" id="phone" name="phone" 
                           pattern="[0-9]{10}" placeholder="07XXXXXXXX" required
                           title="Please enter a valid 10-digit Kenyan phone number">
                    <small class="input-hint">Format: 07XXXXXXXX (10 digits)</small>
                </div>

                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" name="password" 
                           minlength="8" required placeholder="Create a strong password">
                    <div class="password-strength" id="password-strength"></div>
                </div>

                <div class="form-group">
                    <label for="confirmPassword">Confirm Password</label>
                    <input type="password" id="confirmPassword" name="confirmPassword" 
                           required placeholder="Confirm your password">
                </div>

                <!-- Terms and Conditions Agreement -->
                <div class="legal-checkbox-container">
                    <div class="form-group simple-checkbox">
                        <input type="checkbox" id="terms-agreement" name="terms-agreement" required>
                        <label for="terms-agreement">
                            I agree to the <a href="terms.html" target="_blank" class="terms-link">Terms and Conditions</a> 
                            and <a href="privacy.html" target="_blank" class="terms-link">Privacy Policy</a>
                        </label>
                    </div>

                    <div class="form-group simple-checkbox">
                        <input type="checkbox" id="age-verification" name="age-verification" required>
                        <label for="age-verification">
                            I confirm I am 18 years or older
                        </label>
                    </div>
                </div>

                <button type="submit" class="auth-button btn-primary" id="register-button">
                    <span class="btn-text">Create Account</span>
                    <div class="loading hidden"></div>
                </button>

                <div class="message hidden" id="form-message"></div>
            </form>

            <div class="auth-footer">
                <p>Already have an account? <a href="login.html">Sign in here</a></p>
                <p><a href="index.html">‚Üê Back to Home</a></p>
            </div>
        </div>
    </div>

    <!-- Legal Notice - Outside the container with smaller font -->
    <div class="legal-notice">
        <p class="legal-text">
            By clicking Register you confirm to have read in detail, understood and agreed to the 
            <a href="terms.html" target="_blank">Terms and Conditions</a>, the 
            <a href="privacy.html" target="_blank">Privacy Policy</a> and also that you are over 18 years of age.
        </p>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const registerForm = document.getElementById('register-form');
            const passwordInput = document.getElementById('password');
            const confirmPasswordInput = document.getElementById('confirmPassword');
            const passwordStrength = document.getElementById('password-strength');
            const formMessage = document.getElementById('form-message');
            const registerButton = document.getElementById('register-button');
            const btnText = registerButton.querySelector('.btn-text');
            const loading = registerButton.querySelector('.loading');
        });

            // Password strength checker with auto-dismiss
function checkPasswordStrength(password) {
    const strengthContainer = document.getElementById('password-strength-container');
    const strengthText = document.getElementById('password-strength-text');
    const strengthBar = document.getElementById('password-strength-bar');
    
    if (!password) {
        strengthContainer.classList.add('hidden');
        return;
    }
    
    strengthContainer.classList.remove('hidden');
    
    // Remove previous classes
    strengthText.className = 'password-strength';
    strengthBar.className = 'strength-bar';
    
    // Calculate strength
    let strength = 0;
    let feedback = '';
    
    // Length check
    if (password.length >= 8) strength++;
    if (password.length >= 12) strength++;
    
    // Character variety checks
    if (/[a-z]/.test(password)) strength++;
    if (/[A-Z]/.test(password)) strength++;
    if (/[0-9]/.test(password)) strength++;
    if (/[^a-zA-Z0-9]/.test(password)) strength++;
    
    // Determine strength level
    if (strength <= 2) {
        strengthText.textContent = 'Password Strength: Weak';
        strengthText.classList.add('weak');
        strengthBar.classList.add('weak');
    } else if (strength <= 4) {
        strengthText.textContent = 'Password Strength: Medium';
        strengthText.classList.add('medium');
        strengthBar.classList.add('medium');
    } else {
        strengthText.textContent = 'Password Strength: Strong';
        strengthText.classList.add('strong');
        strengthBar.classList.add('strong');
        
        // Auto-dismiss strong password message after 2 seconds
        setTimeout(() => {
            strengthText.classList.add('quick-dismiss');
            setTimeout(() => {
                strengthContainer.classList.add('hidden');
            }, 500);
        }, 2000); // Show for 2 seconds then dismiss
    }
}

// Enhanced version with immediate dismissal option
function checkPasswordStrengthEnhanced(password, immediateDismiss = false) {
    const strengthContainer = document.getElementById('password-strength-container');
    const strengthText = document.getElementById('password-strength-text');
    const strengthBar = document.getElementById('password-strength-bar');
    
    if (!password) {
        hideStrengthIndicator();
        return;
    }
    
    strengthContainer.classList.remove('hidden');
    
    // Remove previous classes
    strengthText.className = 'password-strength';
    strengthBar.className = 'strength-bar';
    
    // Calculate strength
    const strength = calculatePasswordStrength(password);
    
    // Determine strength level
    if (strength <= 2) {
        showStrengthIndicator('weak', 'Password Strength: Weak');
    } else if (strength <= 4) {
        showStrengthIndicator('medium', 'Password Strength: Medium');
    } else {
        showStrengthIndicator('strong', 'Password Strength: Strong');
        
        // Auto-dismiss strong password message
        if (immediateDismiss) {
            // Dismiss immediately
            setTimeout(() => {
                hideStrengthIndicator();
            }, 800); // Very short delay
        } else {
            // Dismiss after 2 seconds
            setTimeout(() => {
                hideStrengthIndicator();
            }, 2000);
        }
    }
}

function calculatePasswordStrength(password) {
    let strength = 0;
    
    // Length check
    if (password.length >= 8) strength++;
    if (password.length >= 12) strength++;
    
    // Character variety checks
    if (/[a-z]/.test(password)) strength++;
    if (/[A-Z]/.test(password)) strength++;
    if (/[0-9]/.test(password)) strength++;
    if (/[^a-zA-Z0-9]/.test(password)) strength++;
    
    return strength;
}

function showStrengthIndicator(level, message) {
    const strengthText = document.getElementById('password-strength-text');
    const strengthBar = document.getElementById('password-strength-bar');
    
    strengthText.textContent = message;
    strengthText.classList.add(level);
    strengthBar.classList.add(level);
}

function hideStrengthIndicator() {
    const strengthContainer = document.getElementById('password-strength-container');
    const strengthText = document.getElementById('password-strength-text');
    
    strengthText.classList.add('quick-dismiss');
    setTimeout(() => {
        strengthContainer.classList.add('hidden');
    }, 500);
}

// Initialize password strength checking
function initializePasswordStrength() {
    const passwordInput = document.getElementById('password');
    if (!passwordInput) return;
    
    let checkTimeout;
    
    passwordInput.addEventListener('input', function() {
        clearTimeout(checkTimeout);
        checkTimeout = setTimeout(() => {
            checkPasswordStrengthEnhanced(this.value, true); // true for immediate dismissal
        }, 300);
    });
    
    // Also check on focus out
    passwordInput.addEventListener('blur', function() {
        checkPasswordStrengthEnhanced(this.value, true);
    });
}

            // Password confirmation validation
            confirmPasswordInput.addEventListener('input', function() {
                if (this.value !== passwordInput.value) {
                    this.setCustomValidity('Passwords do not match');
                } else {
                    this.setCustomValidity('');
                }
            });

            // Form submission
            registerForm.addEventListener('submit', async function(e) {
                e.preventDefault();

                // Validate terms agreement
                const termsAgreement = document.getElementById('terms-agreement');
                const ageVerification = document.getElementById('age-verification');

                if (!termsAgreement.checked) {
                    showMessage('You must agree to the Terms and Conditions and Privacy Policy to register.', 'error');
                    return;
                }

                if (!ageVerification.checked) {
                    showMessage('You must confirm you are 18 years or older to register.', 'error');
                    return;
                }

                const password = passwordInput.value;
                const confirmPassword = confirmPasswordInput.value;

                if (password !== confirmPassword) {
                    showMessage('Passwords do not match. Please check and try again.', 'error');
                    return;
                }

                if (password.length < 8) {
                    showMessage('Password must be at least 8 characters long.', 'error');
                    return;
                }

                await registerUser();
            });

            async function registerUser() {
                const formData = {
                    fullName: document.getElementById('fullName').value,
                    email: document.getElementById('email').value,
                    phone: document.getElementById('phone').value,
                    password: document.getElementById('password').value
                };

                try {
                    // Show loading state
                    btnText.textContent = 'Creating Account...';
                    loading.classList.remove('hidden');
                    registerButton.disabled = true;

                    const response = await fetch('http://localhost:5000/api/auth/register', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(formData)
                    });

                    const data = await response.json();

                    if (response.ok) {
                        showMessage('Account created successfully! Redirecting to login...', 'success');
                        
                        // Store registration data for login page
                        localStorage.setItem('registeredEmail', formData.email);
                        
                        setTimeout(() => {
                            window.location.href = 'login.html';
                        }, 2000);
                    } else {
                        throw new Error(data.message || 'Registration failed');
                    }
                } catch (error) {
                    console.error('Registration error:', error);
                    showMessage(error.message || 'Registration failed. Please try again.', 'error');
                } finally {
                    // Reset button state
                    btnText.textContent = 'Create Account';
                    loading.classList.add('hidden');
                    registerButton.disabled = false;
                }
            }

            function showMessage(message, type = 'info') {
                formMessage.textContent = message;
                formMessage.className = `message ${type}`;
                formMessage.classList.remove('hidden');

                // Auto-hide success messages
                if (type === 'success') {
                    setTimeout(() => {
                        formMessage.classList.add('hidden');
                    }, 5000);
                }
            }

            // Phone number formatting
            document.getElementById('phone').addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                
                // Ensure it starts with 07 for Kenyan numbers
                if (value.startsWith('7')) {
                    value = '0' + value;
                }
                
                // Limit to 10 digits
                value = value.substring(0, 10);
                e.target.value = value;
            });

            // Enhanced input validation
            const inputs = registerForm.querySelectorAll('input[required]');
            inputs.forEach(input => {
                input.addEventListener('blur', function() {
                    if (!this.value) {
                        this.style.borderColor = '#dc3545';
                    } else {
                        this.style.borderColor = '';
                    }
                });

                input.addEventListener('input', function() {
                    if (this.value) {
                        this.style.borderColor = '';
                    }
                });
            });
    </script>
</body>
</html>