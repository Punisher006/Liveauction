<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Auction Dashboard</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header>
        <h1>Welcome to Live Auction Dashboard</h1>
        <nav>
            <ul>
                <li><a href="#auction-timer">Auction Timer</a></li>
                <li><a href="#bidding">Bidding</a></li>
                <li><a href="#bid-status">Bid Status</a></li>
                <li><a href="#contact">Contact</a></li>
            </ul>
        </nav>
    </header>

    <main>
        <!-- Auction Timers Section -->
        <section id="auction-timer" class="section">
            <h2>Auction Timers</h2>
            <div class="timer">
                <p>Next Auction Time: <span id="timer"></span></p>
            </div>
            <script>
                function updateTimer() {
                    // Auction time slots: start and end times
                    const auctionSlots = [
                        { start: "09:00:00", end: "10:00:00" },
                        { start: "13:00:00", end: "14:00:00" },
                        { start: "19:30:00", end: "20:30:00" },
                    ];

                    const now = new Date();
                    let nextSlot = null;

                    // Find the next auction slot
                    for (const slot of auctionSlots) {
                        const [startHours, startMinutes, startSeconds] = slot.start.split(":").map(Number);
                        const start = new Date();
                        start.setHours(startHours, startMinutes, startSeconds, 0);

                        if (now < start) {
                            nextSlot = { startTime: start, endTime: slot.end };
                            break;
                        }
                    }

                    // If no more slots today, set to the first slot tomorrow
                    if (!nextSlot) {
                        const [startHours, startMinutes, startSeconds] = auctionSlots[0].start.split(":").map(Number);
                        const tomorrow = new Date();
                        tomorrow.setDate(tomorrow.getDate() + 1);
                        tomorrow.setHours(startHours, startMinutes, startSeconds, 0);
                        nextSlot = { startTime: tomorrow, endTime: auctionSlots[0].end };
                    }

                    // Countdown logic
                    const interval = setInterval(() => {
                        const now = new Date();
                        const diff = nextSlot.startTime - now;

                        if (diff <= 0) {
                            // Auction time has started, calculate time remaining in the slot
                            const [endHours, endMinutes, endSeconds] = nextSlot.endTime.split(":").map(Number);
                            const end = new Date(nextSlot.startTime);
                            end.setHours(endHours, endMinutes, endSeconds);

                            if (now < end) {
                                document.getElementById("timer").textContent = "Auction ongoing! Ends at: " + nextSlot.endTime;
                            } else {
                                // Slot ended, reload to display next auction
                                clearInterval(interval);
                                document.getElementById("timer").textContent = "Auction Closed. Refresh for Next Slot.";
                            }
                            return;
                        }

                        // Update countdown for next auction
                        const hours = String(Math.floor(diff / (1000 * 60 * 60))).padStart(2, "0");
                        const minutes = String(Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60))).padStart(2, "0");
                        const seconds = String(Math.floor((diff % (1000 * 60)) / 1000)).padStart(2, "0");

                        document.getElementById("timer").textContent = `${hours}:${minutes}:${seconds}`;
                    }, 1000);
                }

                updateTimer();
            </script>
        </section>

        <!-- Bidding Section -->
        <section id="bidding" class="section">
            <h2>Bidding</h2>
            <div class="auction-actions">
                <form id="bid-form">
                    <label for="investment">Enter Amount (KES 500 - 100,000):</label><br>
                    <input type="number" id="investment" name="investment" min="500" max="1000000" required><br><br>

                    <label for="period">Select Investment Period:</label><br>
                    <select id="period" name="period" required>
                        <option value="4">4 Days (30% ROI)</option>
                        <option value="8">8 Days (60% ROI)</option>
                        <option value="12">12 Days (95% ROI)</option>
                    </select><br><br>

                    <button type="submit">Bid</button>
                </form>
            </div>
            <script>
                // Simulate user login status
                const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true'; // Check client-side login

                const bidForm = document.getElementById("bid-form");
                bidForm.addEventListener("submit", (e) => {
                    e.preventDefault();

                    // Check if user is logged in
                    if (!isLoggedIn) {
                        alert("Authentication required. Please login to continue.");
                        window.location.href = "login.html"; // Redirect to the login page
                        return;
                    }

                    const investment = parseFloat(document.getElementById("investment").value);
                    const period = document.getElementById("period").value;

                    // Validate investment amount
                    if (investment < 500 || investment > 100000) {
                        alert("Investment must be between KES 500 and KES 100,000.");
                        return;
                    }

                    alert(`Bid successful for KES ${investment}, for a ${period}-day period. You'll be logged out to allow others to bid.`);
                    window.location.reload();
                });
            </script>
        </section>

        <!-- ======= Bid Status Section ======= -->
        <section id="bid-status" class="section">
            <h2>Your Bid Status</h2>
            <div id="bid-status-container">
                <p>Loading your bid status...</p>
            </div>
        </section>

        <!-- Add script -->
        <script>
            // Fetch and display bid status
            document.addEventListener("DOMContentLoaded", async () => {
                const container = document.getElementById("bid-status-container");

                try {
                    // Replace this URL with your API endpoint
                    const response = await fetch("http://localhost:5000/api/bid-status", {
                        headers: {
                            Authorization: `Bearer ${localStorage.getItem("token")}`, // Use token for authentication
                        },
                    });

                    if (!response.ok) {
                        throw new Error("Failed to fetch bid status. Please log in.");
                    }

                    const bidStatus = await response.json();

                    if (bidStatus.length === 0) {
                        container.innerHTML = "<p>No bids found. Place a bid to see your status.</p>";
                        return;
                    }

                    // Dynamically build the bid status table
                    let statusHTML = `
                        <table>
                            <thead>
                                <tr>
                                    <th>Bid Amount</th>
                                    <th>Status</th>
                                    <th>Seller(s) Details</th>
                                    <th>Time Remaining</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;

                    bidStatus.forEach(bid => {
                        const sellerInfo = bid.sellers.length
                            ? bid.sellers.map(seller => `
                                <p>
                                    <strong>Mpesa Number:</strong> ${seller.phone}<br>
                                    <strong>Mpesa Name:</strong> ${seller.name}<br>
                                    <strong>Status:</strong> ${seller.status}<br>
                                </p>
                            `).join("")
                            : "<p>The system will allocate you a seller within 24 hours.</p>";

                        const timer = bid.timer
                            ? `<p>${bid.timer} hours remaining</p>`
                            : "<p>Activated</p>";

                        const actions = bid.status === "paired" ? `
                            <button onclick="confirmPayment('${bid.id}')">Confirm Payment</button>
                        ` : "N/A";

                        statusHTML += `
                            <tr>
                                <td>${bid.amount} KES</td>
                                <td>${bid.status}</td>
                                <td>${sellerInfo}</td>
                                <td>${timer}</td>
                                <td>${actions}</td>
                            </tr>
                        `;
                    });

                    statusHTML += "</tbody></table>";
                    container.innerHTML = statusHTML;

                } catch (error) {
                    console.error("Error fetching bid status:", error);
                    container.innerHTML = `<p>${error.message}</p>`;
                }
            });

            // Confirm payment for a specific bid
            async function confirmPayment(bidId) {
                try {
                    const response = await fetch(`http://localhost:5000/api/confirm-payment/${bidId}`, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            Authorization: `Bearer ${localStorage.getItem("token")}`, // Use token for authentication
                        },
                    });

                    if (!response.ok) {
                        throw new Error("Failed to confirm payment.");
                    }

                    alert("Payment confirmed successfully!");
                    window.location.reload();
                } catch (error) {
                    console.error("Error confirming payment:", error);
                    alert("Failed to confirm payment. Please try again.");
                }
            }
        </script>

        <!-- Contact Section -->
        <section id="contact" class="section">
            <h2>Contact Us</h2>
            <p>For more information or inquiries, please contact our support team at <a href="mailto:support@liveauction.com">support@liveauction.com</a>.</p>
        </section>
    </main>

    <footer>
        <p>&copy; 2025 Live Auction. All rights reserved.</p>
    </footer>
</body>
</html>
